#!/bin/sh

# Displays number of upgradeable packages.
# For this to work, have a `pacman -Sy` command run in the background as a
# cronjob every so often as root. This script will then read those packages.
# When clicked, it will run an upgrade via pacman.
#
# Add the following text as a file in /usr/share/libalpm/hooks/statusbar.hook:
#
# [Trigger]
# Operation = Upgrade
# Type = Package
# Target = *
#
# [Action]
# Description = Updating statusbar...
# When = PostTransaction
# Exec = /usr/bin/pkill -RTMIN+14 dwmblocks # Or i3blocks if using i3.

case $BLOCK_BUTTON in
1) setsid -f "$TERMINAL" -e sb-popupgrade && remaps ;;
2) notify-send "$(/usr/bin/pacman -Qu)" "$(/usr/bin/yay -Qu --aur)" ;;
3) notify-send "ğŸ Upgrade module" "ğŸ“¦: number of upgradable 'pacman' packages
ğŸ§°: number of upgradable 'yay' packages
- Left click to upgrade all packages
- Middle click to show upgradable packages" ;;
6) setsid -f "$TERMINAL" -e "$EDITOR" "$0" ;;
esac

pacnum=$(pacman -Qu | grep -Fcv "[ignored]" | sed "s/^/ğŸ“¦/;s/^ğŸ“¦0$//g")
yaynum=$(yay -Qu --aur | grep -Fcv "[ignored]" | sed "s/^/ğŸ§°/;s/^ğŸ§°0$//g")
upgradable=""
[ -n "$pacnum" ] && upgradable="${upgradable}${pacnum} "
[ -n "$yaynum" ] && upgradable="${upgradable}${yaynum} "
upgradable=$(echo "$upgradable" | sed 's/ *$//')

printf "%s\n" "$upgradable"
