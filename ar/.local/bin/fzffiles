#!/bin/sh

# The set -e option instructs sh to immediately exit if any command has a non-zero exit status
set -e

# Set new line and tab for word splitting
IFS='
'

# Get the list of selected files with key bindings for specific paths
files=$(fzf-tmux \
  --header "^a pwd ^b public ^d .dotfiles ^f configs ^g git ^h home ^k desktop ^r scripts ^s suckless ^u staged files ^v private ^/ help" \
  --preview "selection={};
    clean=\$(printf '%s' \"\$selection\" | sed -e 's/^ğŸ“„ //' -e 's/^âœ //' -e 's/^âœ… //' -e 's/^âŒ //' -e 's/^ğŸ”€ //' -e 's/^â“ //');
    [ -z \"\$clean\" ] && { echo 'No selection'; exit 0; }
    target=\$(readlink -f \"\$clean\" 2>/dev/null || printf '%s' \"\$clean\");
    if [ -z \"\$target\" ]; then
      echo 'Could not resolve path';
      exit 0;
    fi
    if [ -f \"\$target\" ]; then
      dir=\$(dirname \"\$target\");
      if git_root=\$(git -C \"\$dir\" rev-parse --show-toplevel 2>/dev/null); then
        rel=\${target#\"\$git_root\"/};
        diff_output=\$(git -C \"\$git_root\" diff --color -- \"\$rel\");
        if [ -n \"\$diff_output\" ]; then
          printf '%s\n' \"\$diff_output\"
          exit 0
        fi
        diff_output=\$(git -C \"\$git_root\" diff --color --cached -- \"\$rel\");
        if [ -n \"\$diff_output\" ]; then
          printf '%s\n' \"\$diff_output\"
          exit 0
        fi
      fi
    fi
    if [ -d \"\$target\" ]; then
      eza --color=always --long --all --header --icons --git \"\$target\"
    elif [ -f \"\$target\" ]; then
      bat --color=always --style=header,grid --line-range=:500 \"\$target\"
    else
      file -h \"\$target\"
    fi" \
  --reverse \
  --query="$1" \
  --multi \
  --exit-0 \
  --prompt " ğŸ’¡ " \
  --bind "ctrl-a:change-prompt( âš¡ )+reload(fd -H -L -t f -E .Trash -E .git -E .cache -E node_modules -E .next -E dist -E build -E coverage -E target -E vendor -E .venv -E venv . $PWD)" \
  --bind "ctrl-b:change-prompt( ğŸŒ )+reload(fd -H -L -t f -E .Trash -E .git -E .cache -E node_modules -E .next -E dist -E build -E coverage -E target -E vendor -E .venv -E venv . ${XDG_PUBLICSHARE_DIR:-${HOME}/Public})" \
  --bind "ctrl-d:change-prompt( âš™ï¸ )+reload(fd -H -L -t f -E .Trash -E .git -E .cache -E node_modules -E .next -E dist -E build -E coverage -E target -E vendor -E .venv -E venv . ${XDG_DOTFILES_DIR:-${HOME}/.dotfiles})" \
  --bind "ctrl-f:change-prompt( ğŸ—‚ï¸ )+reload(fd -H -L -t f -E .Trash -E .git -E .cache -E node_modules -E .next -E dist -E build -E coverage -E target -E vendor -E .venv -E venv . ${XDG_CONFIG_HOME:-${HOME}/.config})" \
  --bind "ctrl-g:change-prompt( ï‡’  )+reload(fd -H -L -t f -E .Trash -E .git -E .cache . $HOME/Private/repos $HOME/Public/repos)" \
  --bind "ctrl-h:change-prompt( ğŸ  )+reload(fd -H -L -t f -E .Trash -E .git -E .cache . $HOME)" \
  --bind "ctrl-k:change-prompt( ğŸ–¥ï¸ )+reload(fd -H -L -t f -E .Trash -E .git -E .cache . ${XDG_DESKTOP_DIR:-${HOME}/Desktop})" \
  --bind "ctrl-r:change-prompt( ğŸ‘Ÿ )+reload(fd -H -L -t f -E .Trash -E .git -E .cache -E zsh . ${XDG_SCRIPTS_HOME:-${HOME}/.local/bin})" \
  --bind "ctrl-s:change-prompt( ğŸ›   )+reload(find ${XDG_SOURCES_HOME:-${HOME}/.local/src}/suckless -maxdepth 2 -type f -not -path '*/.git/*')" \
  --bind "ctrl-u:change-prompt( ğŸ“ )+reload(if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then top=\$(git rev-parse --show-toplevel 2>/dev/null); git -C \"\$top\" status --porcelain | awk -v root=\"\$top\" '{
    staged=substr(\$0,1,1);
    unstaged=substr(\$0,2,1);
    file=substr(\$0,4);
    gsub(/^ +/, \"\", file);
    if (file == \"\") next;
    if (staged == \"?\" && unstaged == \"?\") icon=\"ğŸ“„\";
    else if (staged == \"!\" && unstaged == \"!\") icon=\"âŒ\";
    else if (staged != \" \" && staged != \"?\" && unstaged != \" \" && unstaged != \"?\") icon=\"ğŸ”€\";
    else if (staged != \" \" && staged != \"?\") icon=\"âœ…\";
    else if (unstaged != \" \") icon=\"âœ\";
    else icon=\"â“\";
    print icon \" \" root \"/\" file
      }'; else echo 'This is not a git repository.'; fi)" \
  --bind "ctrl-v:change-prompt( ğŸ”’ )+reload(fd -H -L -t f -E .Trash -E .git -E .cache . $HOME/Private)" \
  --bind 'ctrl-/:change-prompt( â“ )+reload(echo "^a all
^b public
^c configs
^d .dotfiles
^g git
^k desktop
^r scripts
^s suckless
^u staged files
^v private
^/ help")')

# Check if any files were selected, and exit if not
[ -z "$files" ] && exit 0

files=$(printf '%s\n' "$files" | sed -e 's/^ğŸ“„ //' -e 's/^âœ //' -e 's/^âœ… //' -e 's/^âŒ //' -e 's/^ğŸ”€ //' -e 's/^â“ //')

if [ -d "$files" ]; then
  absolute_files=$(realpath $files)
  if echo "$absolute_files" | while read -r file; do file --mime-type "$file" | grep -q 'video/'; done; then
    mpv --quiet --loop $absolute_files
  else
    openfiles "$absolute_files"
  fi
else
  openfiles "$files"
fi
